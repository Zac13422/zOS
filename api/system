--System API
 
function update()
    _actualUser = user.getActualUser() or "none"
    _zuser = user.zuser or "none"
    if term.isColor() then
        term.setTextColor(colors.blue)
    end
    print("Starting system update...")
    function Done()
        if term.isColor() then
            term.setTextColor(colors.lime)
        end
        print("Done")
        if term.isColor() then
            term.setTextColor(colors.blue)
        end
    end
 
    function Download(path, file)
        write("[Info] Downloading "..path.."...")
      	if not fs.exists("/data/zpm/branch") then
            data = http.get("http://raw.githubusercontent.com/Zac13422/zOS/master/"..file)
        else
            local f = fs.open("/data/zpm/branch", "r")
            local branch = f.readLine()
            if branch=="testing" then
                data = http.get("http://raw.githubusercontent.com/Zac13422/zOS/testing/"..file)
            else
                data = http.get("http://raw.githubusercontent.com/Zac13422/zOS/master/"..file)
            end
        end
		
        data = data.readAll()
        local file = fs.open(path, "w")
        file.write(data)
        file.close()
        Done() 
    end
       
    Download("/.settings", ".settings")
    Download("/startup", "startup")
    Download("/api/text", "api/text")
    Download("/api/system", "api/system")
    Download("/api/user", "api/user")
    Download("/bin/cd", "bin/cd")
    Download("/bin/date", "bin/date")
    Download("/bin/hidden/login", "bin/hidden/login")
    Download("/bin/logout", "bin/logout")
    Download("/bin/passwd", "bin/passwd")
    Download("/bin/pwd", "bin/pwd")
    Download("/bin/reboot", "bin/reboot")
    Download("/bin/shutdown", "bin/shutdown")  
    Download("/bin/zsh", "bin/zsh")
    Download("/bin/update", "bin/update")
    Download("/bin/useradd", "bin/useradd")
 
    write("Reloading  APIs...")
    system.loadAllSysAPI()
    Done()
	if _actualUser ~= "none then
   		user.setActualUser(_actualUser)
    	user.zuser = _zuser
	end
end
 
function loadSysAPI(api)
    if fs.exists("/api/"..tostring(api)) then
        os.loadAPI("/api/"..tostring(api))
    else
        if term.isColor() then
            term.setTextColor(colors.red)
        end
        print("The API "..api.." doesn't exists.")
        if term.isColor() then
            term.setTextColor(colors.white)
        end
    end
end
 
function loadAllSysAPI()
    apiList = fs.list("/api")
    for i=1, #apiList do
        loadSysAPI(apiList[i])
    end
end
