--System API
 
function update()

    if term.isColor() then
        term.setTextColor(colors.blue)
    end
    print("Starting system update...")
    function Done()
        if term.isColor() then
            term.setTextColor(colors.lime)
        end
        print("Done")
        if term.isColor() then
            term.setTextColor(colors.blue)
        end
    end
 
    function Download(path, file)
        write("[Info] Downloading "..path.."...")
      	if not fs.exists("/data/zpm/branch") then
            stableDl()
        end
		if fs.exists("/data/zpm/branch") then
			local f = fs.open("/data/zpm/branch", "r")
			branch = f.readLine()

			if branch=="testing" then
				testingDl()
			else
				stableDl()
			end
		end
        data = data.readAll()
        local file = fs.open(path, "w")
        file.write(data)
        file.close()
        Done() 
    end
	function stableDl()
		data = https.get("https://raw.githubusercontent.com/Zac13422/zOS/master"..file)
	end

	function testingDl()
		data = https.get("https://raw.githubusercontent.com/Zac13422/zOS/testing"..file)
	end
       
    Download("/.settings", "/.settings")
    Download("/startup", "/startup")
    Download("/api/text", "/api/text")
    Download("/api/system", "/api/system")
    Download("/api/user", "/api/user")
    Download("/bin/cd", "/bin/cd")
    Download("/bin/date", "/bin/date")
    Download("/bin/hidden/login", "/bin/hidden/login")
    Download("/bin/logout", "/bin/logout")
    Download("/bin/passwd", "/bin/passwd")
    Download("/bin/pwd", "/bin/pwd")
    Download("/bin/reboot", "/bin/reboot")
    Download("/bin/shutdown", "/bin/shutdown")  
    Download("/bin/zsh", "/bin/zsh")
    Download("/bin/update", "/bin/update")
    Download("/bin/useradd", "/bin/useradd")

    Done()


end
 
function loadSysAPI(api)
    _actualUser = user.getActualUser()
    _zuser = user.zuser
	print("Reloading all APIS")
    if fs.exists("/api/"..tostring(api)) then
        os.loadAPI("/api/"..tostring(api))
    else
        if term.isColor() then
            term.setTextColor(colors.red)
        end
        print("The API "..api.." doesn't exists.")
        if term.isColor() then
            term.setTextColor(colors.white)
        end
    end
   	user.setActualUser(_actualUser)
    user.zuser = _zuser
end
 
function loadAllSysAPI()
    apiList = fs.list("/api")
    for i=1, #apiList do
        loadSysAPI(apiList[i])
    end
end
